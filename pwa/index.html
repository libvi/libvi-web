<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" default">
    <title>è¯­éŸ³å®šæ—¶æ’­æŠ¥PWA</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }
        
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        input, select {
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #startBtn {
            background: #4CAF50;
            color: white;
        }
        
        #startBtn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        #stopBtn {
            background: #f44336;
            color: white;
        }
        
        #stopBtn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .status-panel {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .log-panel {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .log-entry {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .voice-test {
            margin-top: 20px;
            text-align: center;
        }
        
        #testVoiceBtn {
            background: #2196F3;
            color: white;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—£ï¸ è¯­éŸ³å®šæ—¶æ’­æŠ¥</h1>
        
        <div class="control-panel">
            <div class="input-group">
                <label for="interval">è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰:</label>
                <input type="number" id="interval" min="3" max="3600" value="3">
            </div>
            
            <div class="input-group">
                <label for="apiUrl">APIåœ°å€ï¼ˆæµ‹è¯•ç”¨ï¼‰:</label>
                <input type="text" id="apiUrl" placeholder="https://api.example.com/data" value="https://jsonplaceholder.typicode.com/posts/1">
            </div>
            
            <div class="input-group">
                <label for="voiceSelect">è¯­éŸ³é€‰æ‹©:</label>
                <select id="voiceSelect">
                    <option value="">ç³»ç»Ÿé»˜è®¤</option>
                </select>
            </div>
        </div>
        
        <div class="button-group">
            <button id="startBtn" onclick="startPolling()">å¼€å§‹å®šæ—¶</button>
            <button id="stopBtn" onclick="stopPolling()" disabled>åœæ­¢å®šæ—¶</button>
        </div>
        
        <div class="voice-test">
            <button id="testVoiceBtn" onclick="testVoice()">æµ‹è¯•è¯­éŸ³æ’­æŠ¥</button>
        </div>
        
        <div class="status-panel">
            <div class="status-item">
                <span>å®šæ—¶å™¨çŠ¶æ€:</span>
                <span id="timerStatus">æœªå¯åŠ¨</span>
            </div>
            <div class="status-item">
                <span>ä¸‹æ¬¡è½®è¯¢:</span>
                <span id="nextPoll">--</span>
            </div>
            <div class="status-item">
                <span>è¯­éŸ³æ”¯æŒ:</span>
                <span id="voiceSupport">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
        
        <div class="log-panel" id="logPanel">
            <div class="log-entry">æ¬¢è¿ä½¿ç”¨è¯­éŸ³å®šæ—¶æ’­æŠ¥ç³»ç»Ÿ</div>
        </div>
    </div>

    <script>
        class VoiceTimerPWA {
            constructor() {
                this.pollingTimer = null;
                this.nextPollTime = null;
                this.isPolling = false;
                this.speechSynth = window.speechSynthesis;
                this.voices = [];
                
                this.init();
            }
            
            async init() {
                await this.initServiceWorker();
                await this.loadVoices();
                this.setupEventListeners();
                this.checkVoiceSupport();
                this.addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }
            
            async initServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('./sw.js');
                        this.addLog('Service Worker æ³¨å†ŒæˆåŠŸ');
                    } catch (error) {
                        this.addLog('Service Worker æ³¨å†Œå¤±è´¥: ' + error.message);
                    }
                }
            }
            
            loadVoices() {
                return new Promise((resolve) => {
                    // è¯­éŸ³åˆ—è¡¨åŠ è½½å¯èƒ½è¾ƒæ…¢ï¼Œè®¾ç½®è¶…æ—¶
                    const timeout = setTimeout(() => {
                        if (this.voices.length === 0) {
                            this.voices = this.speechSynth.getVoices();
                        }
                        this.populateVoiceList();
                        resolve();
                    }, 1000);
                    
                    this.speechSynth.onvoiceschanged = () => {
                        clearTimeout(timeout);
                        this.voices = this.speechSynth.getVoices();
                        this.populateVoiceList();
                        resolve();
                    };
                    
                    // ç«‹å³å°è¯•è·å–ä¸€æ¬¡
                    const initialVoices = this.speechSynthesis.getVoices();
                    if (initialVoices.length > 0) {
                        clearTimeout(timeout);
                        this.voices = initialVoices;
                        this.populateVoiceList();
                        resolve();
                    }
                });
            }
            
            populateVoiceList() {
                const voiceSelect = document.getElementById('voiceSelect');
                voiceSelect.innerHTML = '<option value="">ç³»ç»Ÿé»˜è®¤</option>';
                
                // ä¼˜é€‰ä¸­æ–‡è¯­éŸ³
                const chineseVoices = this.voices.filter(voice => 
                    voice.lang.includes('zh') || voice.lang.includes('CN')
                );
                
                const otherVoices = this.voices.filter(voice => 
                    !voice.lang.includes('zh') && !voice.lang.includes('CN')
                );
                
                chineseVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.voiceURI;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
                
                otherVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.voiceURI;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
                
                this.addLog(`åŠ è½½äº† ${this.voices.length} ç§è¯­éŸ³ï¼Œå…¶ä¸­ ${chineseVoices.length} ç§ä¸­æ–‡è¯­éŸ³`);
            }
            
            setupEventListeners() {
                // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†ï¼ˆç†„å±/äº®å±ï¼‰
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.addLog('é¡µé¢è¿›å…¥åå°ï¼ˆç†„å±ï¼‰');
                    } else {
                        this.addLog('é¡µé¢å›åˆ°å‰å°');
                    }
                });
                
                // ç½‘ç»œçŠ¶æ€å˜åŒ–å¤„ç†
                window.addEventListener('online', () => {
                    this.addLog('ç½‘ç»œè¿æ¥æ¢å¤');
                });
                
                window.addEventListener('offline', () => {
                    this.addLog('ç½‘ç»œè¿æ¥æ–­å¼€');
                });
            }
            
            checkVoiceSupport() {
                const supportElem = document.getElementById('voiceSupport');
                if ('speechSynthesis' in window) {
                    supportElem.textContent = 'æ”¯æŒ';
                    supportElem.style.color = '#4CAF50';
                } else {
                    supportElem.textContent = 'ä¸æ”¯æŒ';
                    supportElem.style.color = '#f44336';
                }
            }
            
            async startPolling() {
                if (this.isPolling) return;
                
                const interval = parseInt(document.getElementById('interval').value) * 1000;
                if (interval < 3000) {
                    alert('è½®è¯¢é—´éš”ä¸èƒ½å°äº3ç§’');
                    return;
                }
                
                this.isPolling = true;
                this.updateButtonStates();
                
                this.addLog(`å¼€å§‹å®šæ—¶è½®è¯¢ï¼Œé—´éš”: ${interval/1000}ç§’`);
                
                // ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡è½®è¯¢
                await this.executePoll();
                
                // è®¾ç½®å®šæ—¶å™¨
                this.pollingTimer = setInterval(async () => {
                    await this.executePoll();
                }, interval);
                
                this.updateNextPollTime(interval);
            }
            
            stopPolling() {
                if (!this.isPolling) return;
                
                this.isPolling = false;
                clearInterval(this.pollingTimer);
                this.pollingTimer = null;
                this.nextPollTime = null;
                
                this.updateButtonStates();
                document.getElementById('nextPoll').textContent = '--';
                document.getElementById('timerStatus').textContent = 'å·²åœæ­¢';
                
                this.addLog('å®šæ—¶è½®è¯¢å·²åœæ­¢');
            }
            
           
            async executePoll() {
                try {
                    const apiUrl = document.getElementById('apiUrl').value;
                    this.addLog(`å¼€å§‹è¯·æ±‚æ•°æ®: ${apiUrl}`);
                    
                    // const response = await fetch(apiUrl, {
                    //     method: 'GET',
                    //     headers: {
                    //         'Content-Type': 'application/json',
                    //     },
                    //     cache: 'no-cache'
                    // });
                    
                    // if (!response.ok) {
                    //     throw new Error(`HTTP error! status: ${response.status}`);
                    // }
                    
                    // const data = await response.json();

                    this.addLog('æ•°æ®è·å–æˆåŠŸ');


                    // è¯­éŸ³æ’­æŠ¥ç»“æœ
                    //const message = this.formatDataForSpeech(data);
                    //this.speakMessage(message);

                    index++;
                    this.speakMessage(index);
                    
                } catch (error) {
                    this.addLog('è¯·æ±‚å¤±è´¥: ' + error.message);
                    this.speakMessage('æ•°æ®è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            }
            
            formatDataForSpeech(data) {
                // æ ¹æ®å®é™…APIå“åº”ç»“æ„è°ƒæ•´è¿™ä¸ªå‡½æ•°
                if (typeof data === 'object') {
                    if (data.title) {
                        return `æœ€æ–°æ•°æ®ï¼š${data.title.substring(0, 50)}`;
                    } else if (data.message) {
                        return `æœåŠ¡å™¨è¿”å›ï¼š${data.message}`;
                    } else {
                        return `æ”¶åˆ°æ•°æ®æ›´æ–°ï¼Œæ—¶é—´ï¼š${new Date().toLocaleTimeString()}`;
                    }
                }
                return `æ•°æ®æ›´æ–°ï¼Œæ—¶é—´ï¼š${new Date().toLocaleTimeString()}`;
            }
            
            speakMessage(message) {
                if (!this.isPolling) return;
                
                if ('speechSynthesis' in window) {
                    // åœæ­¢å½“å‰å¯èƒ½æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³
                    this.speechSynth.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    // é€‰æ‹©è¯­éŸ³
                    const voiceSelect = document.getElementById('voiceSelect');
                    if (voiceSelect.value) {
                        const selectedVoice = this.voices.find(voice => 
                            voice.voiceURI === voiceSelect.value
                        );
                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                        }
                    }
                    
                    utterance.onstart = () => {
                        this.addLog('å¼€å§‹è¯­éŸ³æ’­æŠ¥: ' + message);
                    };
                    
                    utterance.onend = () => {
                        this.addLog('è¯­éŸ³æ’­æŠ¥ç»“æŸ');
                    };
                    
                    utterance.onerror = (event) => {
                        this.addLog('è¯­éŸ³æ’­æŠ¥é”™è¯¯: ' + event.error);
                    };
                    
                    this.speechSynth.speak(utterance);
                } else {
                    this.addLog('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
                }
            }
            
            testVoice() {
                const testMessage = 'è¿™æ˜¯è¯­éŸ³æµ‹è¯•ï¼Œå½“å‰æ—¶é—´ï¼š' + new Date().toLocaleTimeString();
                this.speakMessage(testMessage);
            }
            
            updateButtonStates() {
                document.getElementById('startBtn').disabled = this.isPolling;
                document.getElementById('stopBtn').disabled = !this.isPolling;
                document.getElementById('timerStatus').textContent = 
                    this.isPolling ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
            }
            
            updateNextPollTime(interval) {
                this.nextPollTime = new Date(Date.now() + interval);
                document.getElementById('nextPoll').textContent = 
                    this.nextPollTime.toLocaleTimeString();
            }
            
            addLog(message) {
                const logPanel = document.getElementById('logPanel');
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                logPanel.appendChild(logEntry);
                logPanel.scrollTop = logPanel.scrollHeight;
                
                // ä¿æŒæ—¥å¿—æ•°é‡ä¸è¶…è¿‡50æ¡
                if (logPanel.children.length > 50) {
                    logPanel.removeChild(logPanel.firstChild);
                }
            }
        }
        
        let index=0;

        // å…¨å±€å‡½æ•°ä¾›æŒ‰é’®è°ƒç”¨
        let voiceTimerApp;
        
        function startPolling() {
            if (voiceTimerApp) {
                voiceTimerApp.startPolling();
            }
        }
        
        function stopPolling() {
            if (voiceTimerApp) {
                voiceTimerApp.stopPolling();
            }
        }
        
        function testVoice() {
            if (voiceTimerApp) {
                voiceTimerApp.testVoice();
            }
        }
        
        // åº”ç”¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            voiceTimerApp = new VoiceTimerPWA();
            
            // PWAå®‰è£…æç¤º
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                voiceTimerApp.addLog('å¯ä»¥å°†æ­¤åº”ç”¨å®‰è£…åˆ°ä¸»å±å¹•ä»¥è·å¾—æ›´å¥½ä½“éªŒ');
            });
        });
    </script>
</body>
</html>